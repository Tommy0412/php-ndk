name: Docker Build and Release Asset

on:
  push:
    branches: 
      - master
      - main
  create:
    tags:
      - 'v*.*.*'

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # --- Build the Docker Image ---
    - name: Build Docker image and load to Docker daemon
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: php-ndk-image:latest 
        # CRITICAL FIX: Load the image into the local Docker daemon so 'docker save' can find it.
        load: true
        # Optional: Add caching for faster subsequent builds
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # --- Save the Image as a Tar Archive ---
    - name: Save Docker image as tar
      run: |
        # This command will now succeed because the image is in the local daemon's inventory.
        docker save php-ndk-image:latest -o php-ndk-image.tar

    # --- Upload the Tar Archive to the Release ---
    - name: Upload Release Asset
      id: upload-asset 
      uses: softprops/action-gh-release@v2
      with:
        files: php-ndk-image.tar 
        body: |
          Docker image archive for release ${{ github.ref_name }}.
